!-----------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-----------------------------------------------------------------------------

!> Test the global mesh collection object
!>
module global_mesh_collection_mod_test

  use constants_mod,              only: i_def, str_max_filename
  use global_mesh_mod,            only: global_mesh_type
  use global_mesh_collection_mod, only: global_mesh_collection_type            &
                                      , global_mesh_collection

  use pFUnit_Mod

  implicit none
  
  private
  public :: test_all

  @TestCase
  type, extends(TestCase), public :: global_mesh_collection_test_type
    private
    type(global_mesh_type) :: CubedSphere
    type(global_mesh_type) :: BiPeriodic
    type(global_mesh_type) :: TestGlobalMesh

  contains
    procedure setUp
    procedure tearDown
    procedure test_all
  end type global_mesh_collection_test_type

  character(str_max_filename), parameter ::                                    &
      CubedSphereFile = 'data/ugrid_quads_2d_cubedsphere_6x4x4.nc' 
  character(str_max_filename), parameter :: &
      BiPeriodicFile  = 'data/ugrid_quads_2d_biperiodic_8x8.nc' 

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    implicit none

    class(global_mesh_collection_test_type), intent(inout) :: this

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    implicit none

    class(global_mesh_collection_test_type), intent(inout) :: this

  end subroutine tearDown

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_all( this )

    implicit none

    class(global_mesh_collection_test_type), intent(inout) :: this

    type(global_mesh_type), pointer :: CubedSphere_mesh => null()
    type(global_mesh_type), pointer :: BiPeriodic_mesh  => null()
    type(global_mesh_type), pointer :: test_mesh        => null()

    type(global_mesh_type), pointer :: tmp_global_mesh  => null()

    integer (i_def) :: n_meshes
    integer (i_def) :: test_global_mesh_id
    integer (i_def) :: CubedSphere_mesh_id
    integer (i_def) :: BiPeriodic_mesh_id

    ! Create a mesh collection
    global_mesh_collection = global_mesh_collection_type()

    ! Load in 3 global meshes, 
    ! 1) Cubed-sphere
    ! 2) Bi-periodic
    ! 3) Global Test Mesh

    test_global_mesh_id = global_mesh_collection%add_unit_test_global_mesh()

    CubedSphere_mesh_id = global_mesh_collection%add_new_global_mesh( CubedSphereFile )
    BiPeriodic_mesh_id  = global_mesh_collection%add_new_global_mesh( BiPeriodicFile  )

    test_mesh        => global_mesh_collection%get_global_mesh( test_global_mesh_id )
    CubedSphere_mesh => global_mesh_collection%get_global_mesh( CubedSphere_mesh_id )
    BiPeriodic_mesh  => global_mesh_collection%get_global_mesh( BiPeriodic_mesh_id  )


    ! Test ids are different
    @assertTrue ( test_global_mesh_id /= CubedSphere_mesh_id )
    @assertTrue ( BiPeriodic_mesh_id  /= CubedSphere_mesh_id )
    @assertTrue ( BiPeriodic_mesh_id  /= test_global_mesh_id )

    ! Destroy global_mesh_collection
    call global_mesh_collection%clear()
 
  end subroutine test_all

end module global_mesh_collection_mod_test
